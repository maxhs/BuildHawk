<div id="billing" class="border-box" style="">
	<h3><%= @month.strftime("%b") %> SUMMARY</h3>
	<% if @company.cards.count > 0 %>
		<div id="billing-container"style="border:1px solid #eee;">
			<div class="row">
				<div class="col-xs-3"><h4>Billing Cycle</h4></div>
				<div class="col-xs-3"><h4># Pro Users</h4></div>
				<div class="col-xs-2"><h4>Projected Cost</h4></div>
				<div class="col-xs-2"><h4>Due</h4></div>
				<div class="col-xs-2"><h4>Credit</h4></div>
			</div>
				
			<%= render partial:"billing/summary", locals: {pro_users: @pro_users, invoice: @invoice, month: @month, user: @user} %>
			
		</div>

		<div class="row">
			<div class="col-xs-6" id="cards-management">
				<h3>CARDS ON FILE</h3>
				<% if @cards %>
					<table>
						<% @cards.each do |c| %>
							<tr>
								<td><%= link_to "#{c.brand} - *** #{c.last4}", edit_card_billing_index_path(card_id: c.id), remote: true %></td>
								<td><% if c.active %><span style='padding-left:10px;font-size:.9em;color:#aaa;'>(Primary)</span><% end %></td>
							</tr>
						<% end %>
					</table>
				<% else %>
					<span>You don't have any active cards.</span>
				<% end %>

				<%= link_to "Add New Card", new_card_billing_index_path, :class=>"simple-btn", id:"new-card", remote:true %>
				
			</div>

			<div class="col-xs-6" id="billing-history">
				<h3>Past Bills</h3>
				<span id="bill-label">View bill for:</span>
				<select id="past-invoices">
					<%= @invoices.each do |invoice| %>
						<option value="<%=invoice['id']%>">
							<%= parse_month_date(Time.at(invoice["period_start"]).to_datetime) %> - <%= parse_month_date_year(Time.at(invoice["period_end"]).to_datetime) %>
						</option>
					<% end %>
				</select>
				<%= link_to "View",'',id:"view-invoice-link", :class=>"simple-btn remote", target:"_blank" %>
			</div>
		</div>

		<div style="font-style:italic;color:#aaa;text-align:center;margin-top:20px;" class="font-smoothing">Your card on file will be automatically billed at the end of each month</div>
	<% else %>
		<div id="new-billing-container" class="border-box">
			<div class="billing-prompt" style="padding:10px;">
				Please set up your company's billing information in order to create new projects, manage users and more.
			</div>
			<%= form_tag billing_index_path, method: :post, :id=>"payment-form", remote:true do %>
				<%= hidden_field_tag :authenticity_token, form_authenticity_token %>
			  	<span class="payment-errors"></span>
				<div class="form-row">
			    	<label>
			      		<span>Card Number</span>
			     		<input type="text" size="20" data-stripe="number" class="card-info"/>
			    	</label>
			    	<label>
			      		<span>CVC</span>
			      		<input type="text" size="4" data-stripe="cvc"/>
			    	</label>
			 	</div>

			  	<div class="form-row">
			    	<label>
			      		<span>Expiration (MM/YYYY)</span>
			      		<input type="text" size="2" data-stripe="exp-month"/>
			    	</label>
			    	<span> / </span>
			    	<input type="text" size="4" data-stripe="exp-year"/>
			  	</div>

			  	<div style="text-align:center;"><%=submit_tag "Add", :class=>"simple-btn" %></div>
			<% end %>
		</div>
	<% end %>
</div>

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript">
	var stripeResponseHandler = function(status, response) {
		var form = $('#payment-form');
		if (response.error) {
		    form.find('.payment-errors').text(response.error.message);
		    form.find('button').prop('disabled', false);
		} else {
		    var token = response.id;
		    form.append($('<input type="hidden" name="stripeToken" />').val(token));
		    form.get(0).submit();
		}
	};
	$('#view-invoice-link').click(function(e){
		e.preventDefault();
		var stuff = $('#past-invoices').val();
		$(this).attr('href','<%= invoice_billing_index_url %>?invoice_id='+stuff);
		window.open('<%= invoice_billing_index_url %>?invoice_id='+stuff);
		//$(this).click();
	});
	$(document).ready(function() {
		$('#payment-form').submit(function(event) {
		    var form = $(this);
		    form.find('button').prop('disabled', true);
		    Stripe.setPublishableKey('<%=@stripe_key%>');
		    var token = Stripe.card.createToken(form, stripeResponseHandler);
		    event.preventDefault();
		    return false;
		});
	});
</script>