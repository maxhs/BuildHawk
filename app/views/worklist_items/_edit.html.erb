<%= nested_form_for task, url: worklist_item_path(task), :multipart => true, :method => :patch, :remote => true do |f| %>
	<%= hidden_field_tag :authenticity_token, form_authenticity_token %>

	<div id="worklist-item-container" class="border-box container">

		<div id="dismiss-task">
			<%= image_tag "blackX.png",id:"dismiss-task" %>
		</div>

		<header class="row">
			<h4 style="text-align:center;margin-bottom:5px;"><%=task.body%></h4>
		</header>
		
		<div class="row">
			<div class="col-xs-3"><h5>Task</h5></div>
			<div class="col-xs-9"><%= f.text_field :body, :placeholder => "Describe the task" %></div>
		</div>
		<div class="row">
			<div class="col-xs-3">
				<h5>Location</h5>
			</div>
			<div class="col-xs-9">
				<%= f.text_field :location, :placeholder => "Add a location (optional)" %>
			</div>		
		</div>
		<div class="row" style="margin-bottom:2.5%;">
			<div class="col-xs-3"><h5>Status</h5></div>
			<div class="col-xs-9">
				<div>
					<%= f.radio_button :completed, false %><h5 style="display:inline-block">IN PROGRESS</h5>
				</div>
				<div>
					<%= f.radio_button :completed, true %><h5 style="display:inline-block">COMPLETED</h5>
					<% if task.completed_by_user %>
						<h5 style="color:#aaa;margin-left:5%;display:inline-block;font-size:1em;font-weight:100;"> by <%= task.completed_by_user.full_name %>, <%= parse_time task.completed_at %></h5>
					<% end %>
				</div>
			</div>
		</div>

	<% if !task.completed_by_user %>
		<div class="row">
			<%= f.fields_for :assignee do |a| %>
				<h5 class="col-xs-3">Assignee</h5>
				<div class="col-xs-9">
					<%= a.select :full_name, @users.map(&:full_name).unshift("No Assignment"), {:include_blank => false}, :class=>"assignee-select", :style => "text-align:center;display:inline-block;font-size:1.2em;position:relative;top:-3px;" %>
				</div>
			<% end %>
		</div>
		<div class="row">
			<%= f.fields_for :connect_assignee do |a| %>
				<h5 class="col-xs-3">Connect Users</h5>
				<div class="col-xs-9">
					<%= a.select :id, options_for_select(@connect_users.map{|cu| [cu.full_name, cu.id]}.unshift("No Assignment"), selected: f.object.connect_assignee_id), {:include_blank => false}, :class=>"assignee-select", :style => "text-align:center;display:inline-block;font-size:1.2em;position:relative;top:-3px;" %>
				</div>
			<% end %>
		</div>
	<% end %>
		
	<% if task.photos && task.photos.count > 0 %>
		<div class="row">
			<div style="padding:30px 0;padding-top:20px;">
				<% task.photos.each do |p| %>
					<% if p.image_file_name%>
						<%= render :partial => "photos/image", :locals => {:p => p} %>
					<% end %>
				<% end %>
			</div>
		</div>
	<% end %>
	
	<div class="row">
		<h5>Add a photo</h5>
		<%= f.fields_for :photos, task.photos.build do |photo| %>
			<%= hidden_field_tag :authenticity_token, form_authenticity_token %>
			<%= photo.file_field :image %>
			<%= photo.hidden_field :project_id, :value => @project.id %>
			<%= photo.hidden_field :user_id, :value => current_user.id %>
			<% if task.id %><%= photo.hidden_field :worklist_item_id, :value => task.id %><% end %>
			<%= photo.hidden_field :source, :value => "Worklist" %>
		<% end %>
	</div>


		<div class="button-container row">
			<%= f.submit "Save", :class => "simple-btn save" %>
	<% end %>

			<% if current_user.admin || current_user.company_admin || current_user.uber_admin || task.user == current_user %>
				<%= link_to image_tag('trashButton.png',:class=> "remote delete-img"), worklist_item_path(task), :method => :delete, :class=> "delete-link", :data => {:confirm => "Are you sure you want to delete this task?"}, remote: true %>
			<% end %>
		</div>

		<h5 id="comment-toggle">View Comments</h5>
	</div>

	<div id="comment-container" class="collapsed border-box">
		<div id="comments-form">
			<%= form_for task.comments.new, :method => :post, remote: true do |f| %>
				<%= hidden_field_tag :authenticity_token, form_authenticity_token %>
				<%= f.text_area :body, :rows => "3", :placeholder => "Type your notes/comment here" %>
				<%= f.hidden_field :user_id, :value => current_user.id %>
				<%= f.hidden_field :worklist_item_id, :value => task.id %>
				<%= f.submit "Send", :class => "simple-btn pull-right", :style => "margin-top:14px;", remote:true %>
			<% end %>
		</div>
		<%= render :partial => "comments/comments", :locals => {:comments => task.comments} %>
	</div>


<script>
	$('#dismiss-task').click(function(){
		dismissTask();
	});
	$('#comment-toggle').click(function(){
		if ($('#comment-container').hasClass('collapsed')){
			$(this).text('Comments');
			$('#comment-container').show(170,function(){
				$(this).removeClass('collapsed');
			});
		} else {
			$(this).text('View Comments');
			$('#comment-container').addClass('collapsed');
			$('#comment-container').hide(170);
		}
	});
</script>