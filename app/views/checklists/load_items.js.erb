var itemsHolder = $('#<%= @phase.id %>-items');
if (itemsHolder.hasClass('revealed')){
	itemsHolder.hide(300,function(){
		$('#phase-<%=@phase.id%> .disclosure').text('[-]');
	});
	itemsHolder.removeClass('revealed');
	
} else {
	$('html, body').animate({
        scrollTop: $('#phase-<%=@phase.id %>').offset().top-50
    }, 1000);
	itemsHolder.fadeOut(200,function(){
		<% if @project %>
			$(this).html('<%= j render partial:"projects/category", collection:@categories, as: :category, cache: false %><%= link_to "Add a new category", new_category_path(:phase_id => @phase.id,:project_id => @project.id), :id=>"new-category-#{@phase.id}", :class=>"remote new-category", remote: true %>');
		<% else %>
			$(this).html('<%= j render partial:"admin/category", collection:@categories, as: :category, cache: false %><%= link_to "Add a new category", new_category_path(:phase_id => @phase.id), :id=>"new-category-#{@phase.id}", :class=>"remote new-category", remote: true %>');
			itemsHolder.children(":first").find(".items-container").removeClass("collapsed");
		<% end %>

		$(this).addClass('revealed');
		$(this).show(300,function(){
			$('#phase-<%=@phase.id%> .disclosure').text('[+]');
			<% @phase.categories.each do |category| %>
		        $('#items-<%=category.id%>').sortable({
		          axis: 'y',
		          dropOnEmpty:true,
		          cursor: 'move',
		          items: 'li',
		          opacity: 0.4,
		          scroll: true,
		          stop: function(){
		            $.ajax({
		                type: 'post',
		                data: $('#items-<%=category.id%>').sortable('serialize') + '&id=<%= category.id %>',
		                dataType: 'script',
		                url: '/checklists/order_items'
		            })
		          }
		        });  
	        <% end %>
		});

		$('.category .title').on('click',function(e){
			var catId = e.target.id;
			var cat = $('#category-'+catId+'-container');	
	        if (cat.hasClass("collapsed")){
	        	cat.show(200,function(){
	        		cat.removeClass('collapsed');
	        	});
	        } else {
	        	cat.hide(200,function(){
	        		cat.addClass('collapsed');
	        	});
	        }
		});
	});
}

