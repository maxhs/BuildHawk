var itemsHolder = $('#<%= @category.id %>-items');
if (itemsHolder.hasClass('revealed')){
	itemsHolder.hide(300,function(){
		$('#new-category-<%=@category.id%>').fadeOut(200);
		$('#phase-<%=@category.id%> .disclosure').text('[-]');
	});
	itemsHolder.removeClass('revealed');
	
} else {
	$('html, body').animate({
        scrollTop: $('#phase-<%=@category.id %>').offset().top-50
    }, 1000);
	itemsHolder.fadeOut(200,function(){
		<% if @project %>
			$(this).html('<%= j render partial:"projects/subcategory", collection:@subcategories, as: :subcategory, cache: false %><%= link_to "Add a new category", new_subcategory_path(:category_id => @category.id,:project_id => @project.id), :id=>"new-category-#{@category.id}", :class=>"remote new-category", remote: true %>');
		<% else %>
			$(this).html('<%= j render partial:"admin/subcategory", collection:@subcategories, as: :subcategory, cache: false %><%= link_to "Add a new category", new_subcategory_path(:category_id => @category.id), :id=>"new-category-#{@category.id}", :class=>"remote new-category", remote: true %>');
			itemsHolder.children(":first").find(".items-container").removeClass("collapsed");
		<% end %>

		$(this).addClass('revealed');
		$(this).show(300,function(){
			$('#new-category-<%=@category.id%>').fadeIn(200);
			$('#phase-<%=@category.id%> .disclosure').text('[+]');
			<% @category.subcategories.each do |subcategory| %>
		        $('#items-<%=subcategory.id%>').sortable({
		          axis: 'y',
		          dropOnEmpty:true,
		          cursor: 'move',
		          items: 'li',
		          opacity: 0.4,
		          scroll: true,
		          stop: function(){
		            $.ajax({
		                type: 'post',
		                data: $('#items-<%=subcategory.id%>').sortable('serialize') + '&id=<%= subcategory.id %>',
		                dataType: 'script',
		                url: '/checklists/order_items'
		            })
		          }
		        });  
	        <% end %>
		});

		$('.subcategory .title').on('click',function(e){
			var subId = e.target.id;
			var sub = $('#sub-'+subId);	
	        if (sub.hasClass("collapsed")){
	        	sub.show(200,function(){
	        		sub.removeClass('collapsed');
	        	});
	        } else {
	        	sub.hide(200,function(){
	        		sub.addClass('collapsed');
	        	});
	        }
		});
	});
}

